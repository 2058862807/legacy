<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Will - NexteraEstate</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto py-8 px-4">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Create Your Will</h1>
            <p class="text-gray-600">Simple, fast, legally compliant will creation</p>
        </div>

        <div id="willForm" class="bg-white rounded-xl shadow-lg p-8">
            <form id="createWillForm">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="fullName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter your full legal name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="your@email.com">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address *</label>
                    <input type="text" id="address" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Street address">
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                        <input type="text" id="city" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="City">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">State *</label>
                        <select id="state" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select State</option>
                            <option value="CA">California</option>
                            <option value="NY">New York</option>
                            <option value="TX">Texas</option>
                            <option value="FL">Florida</option>
                            <option value="IL">Illinois</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="OH">Ohio</option>
                            <option value="GA">Georgia</option>
                            <option value="NC">North Carolina</option>
                            <option value="MI">Michigan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code *</label>
                        <input type="text" id="zip" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="ZIP code">
                    </div>
                </div>

                <hr class="my-8">

                <h3 class="text-xl font-semibold text-gray-900 mb-4">Beneficiary</h3>
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beneficiary Name</label>
                        <input type="text" id="beneficiaryName" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Full name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Relationship</label>
                        <select id="beneficiaryRelationship" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select relationship</option>
                            <option value="Spouse">Spouse</option>
                            <option value="Child">Child</option>
                            <option value="Parent">Parent</option>
                            <option value="Sibling">Sibling</option>
                            <option value="Friend">Friend</option>
                            <option value="Charity">Charity</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Percentage</label>
                        <input type="number" id="beneficiaryPercentage" min="1" max="100" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="100">
                    </div>
                </div>

                <hr class="my-8">

                <h3 class="text-xl font-semibold text-gray-900 mb-4">Asset (Optional)</h3>
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asset Description</label>
                        <input type="text" id="assetDescription" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., Savings Account">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asset Type</label>
                        <select id="assetType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select type</option>
                            <option value="Bank Account">Bank Account</option>
                            <option value="Real Estate">Real Estate</option>
                            <option value="Investment Account">Investment Account</option>
                            <option value="Vehicle">Vehicle</option>
                            <option value="Personal Property">Personal Property</option>
                            <option value="Business Interest">Business Interest</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Value ($)</label>
                        <input type="number" id="assetValue" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="50000">
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" id="createBtn"
                            class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Create My Will Now
                    </button>
                </div>
            </form>
        </div>

        <div id="successMessage" class="hidden bg-white rounded-xl shadow-lg p-8 text-center">
            <div class="text-6xl mb-4">âœ…</div>
            <h2 class="text-3xl font-bold text-green-600 mb-4">Will Created Successfully!</h2>
            <div id="willDetails" class="bg-gray-50 rounded-lg p-6 mb-6 text-left max-w-md mx-auto"></div>
            <div class="space-y-4">
                <button onclick="notarizeWill()" id="notarizeBtn" 
                        class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700">
                    ðŸ”— Notarize on Blockchain
                </button>
                <button onclick="resetForm()" 
                        class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700">
                    Create Another Will
                </button>
            </div>
        </div>

        <div id="loadingMessage" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
            <p class="text-gray-600 font-medium">Creating your will...</p>
        </div>
    </div>

    <script>
        let currentWillId = null;
        let currentUserEmail = null;

        document.getElementById('createWillForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await createWill();
        });

        async function createWill() {
            const createBtn = document.getElementById('createBtn');
            const loadingMessage = document.getElementById('loadingMessage');
            
            createBtn.disabled = true;
            loadingMessage.classList.remove('hidden');

            try {
                // Get form data
                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('email').value;
                const address = document.getElementById('address').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const zip = document.getElementById('zip').value;

                currentUserEmail = email;

                // Create user first
                const userData = {
                    email: email,
                    name: fullName
                };

                const userResponse = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (!userResponse.ok) {
                    throw new Error(`User creation failed: ${userResponse.status}`);
                }

                // Prepare will data
                const beneficiaries = [];
                const beneficiaryName = document.getElementById('beneficiaryName').value;
                const beneficiaryRelationship = document.getElementById('beneficiaryRelationship').value;
                const beneficiaryPercentage = document.getElementById('beneficiaryPercentage').value;

                if (beneficiaryName && beneficiaryRelationship && beneficiaryPercentage) {
                    beneficiaries.push({
                        name: beneficiaryName,
                        relationship: beneficiaryRelationship,
                        percentage: parseInt(beneficiaryPercentage)
                    });
                }

                const assets = [];
                const assetDescription = document.getElementById('assetDescription').value;
                const assetType = document.getElementById('assetType').value;
                const assetValue = document.getElementById('assetValue').value;

                if (assetDescription && assetType && assetValue) {
                    assets.push({
                        type: assetType,
                        description: assetDescription,
                        value: parseFloat(assetValue)
                    });
                }

                const willData = {
                    state: state,
                    personal_info: {
                        name: fullName,
                        address: address,
                        city: city,
                        state: state,
                        zip: zip
                    },
                    beneficiaries: beneficiaries,
                    assets: assets
                };

                // Create will
                const willResponse = await fetch(`/api/wills?user_email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(willData)
                });

                if (!willResponse.ok) {
                    const errorText = await willResponse.text();
                    throw new Error(`Will creation failed: ${willResponse.status} - ${errorText}`);
                }

                const willResult = await willResponse.json();
                currentWillId = willResult.id;

                // Show success
                document.getElementById('willForm').classList.add('hidden');
                document.getElementById('willDetails').innerHTML = `
                    <div class="space-y-2">
                        <p><strong>Will ID:</strong> ${willResult.id}</p>
                        <p><strong>Name:</strong> ${willResult.personal_info.name}</p>
                        <p><strong>State:</strong> ${willResult.state}</p>
                        <p><strong>Completion:</strong> ${willResult.completion_percentage}%</p>
                        <p><strong>Created:</strong> ${new Date(willResult.created_at).toLocaleDateString()}</p>
                    </div>
                `;
                document.getElementById('successMessage').classList.remove('hidden');

            } catch (error) {
                alert(`Error creating will: ${error.message}`);
                console.error('Will creation error:', error);
            } finally {
                loadingMessage.classList.add('hidden');
                createBtn.disabled = false;
            }
        }

        async function notarizeWill() {
            if (!currentWillId || !currentUserEmail) {
                alert('No will to notarize');
                return;
            }

            const notarizeBtn = document.getElementById('notarizeBtn');
            notarizeBtn.disabled = true;
            notarizeBtn.textContent = 'ðŸ”— Notarizing...';

            try {
                const response = await fetch('/api/gasless-notary/notarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        document_id: currentWillId,
                        document_type: 'will',
                        user_email: currentUserEmail
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Notarization failed: ${errorText}`);
                }

                const result = await response.json();
                alert(`âœ… Will successfully notarized on blockchain!\n\nTransaction Hash: ${result.transaction_hash}\nNetwork: ${result.network}`);

            } catch (error) {
                alert(`Error notarizing will: ${error.message}`);
                console.error('Notarization error:', error);
            } finally {
                notarizeBtn.disabled = false;
                notarizeBtn.textContent = 'ðŸ”— Notarize on Blockchain';
            }
        }

        function resetForm() {
            document.getElementById('willForm').classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('createWillForm').reset();
            currentWillId = null;
            currentUserEmail = null;
        }
    </script>
</body>
</html>